// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.10/esri/copyright.txt for details.

define(["require","exports","../../../../../core/tsSupport/declareExtendsHelper","../../../../../core/tsSupport/decorateHelper","../../../../../core/tsSupport/assignHelper","../../../../../renderers","../../../../../core/Accessor","../../../../../core/Logger","../../../../../core/screenUtils","../../../../../core/accessorSupport/decorators","../../../../../geometry/support/aaBoundingRect","../../../../../renderers/support/diffUtils","../../../../../support/arcadeUtils","../../../engine/webgl/rendererInfoUtils","../../../engine/webgl/visualVariablesUtils","../../../engine/webgl/WGLFeatureView","../../../engine/webgl/WGLTile","./BaseTileRenderer"],function(e,i,t,r,o,n,l,a,s,u,f,c,p,d,h,g,v,b){function y(e){for(var i in e.diff){var t=e.diff[i];if("collection"===t.type){if(0!==t.changed.length||0!==t.added.length||0!==t.removed.length)return!0}else if("visualVariables"!==i&&"authoringInfo"!==i)return!0}return!1}function V(e){if(!("visualVariables"in e&&e.visualVariables&&e.visualVariables.length))return e;var i=e.clone(),t=i.visualVariables.map(function(e){return w(e)?m(e):e});return i.visualVariables=t,i}function w(e){return("size"===e.type||"color"===e.type||"opacity"===e.type)&&null!=e.stops}function m(e){return e.stops=T(e.type,e.stops),e}function I(e,i,t){return(1-t)*e+t*i}function R(e,i){for(var t=i[0],r=i.slice(1),o=r.pop(),n=r[0].value,l=r[r.length-1].value,a=(l-n)/N,u=[],f=n;f<l;f+=a){for(var c=0;f>=r[c].value;)c++;var p=r[c],d=i[c-1],h=f-d.value,g=p.value===d.value?1:h/(p.value-d.value);if("color"===e){var v=r[c],b=i[c-1],y=v.color.clone();y.r=I(b.color.r,y.r,g),y.g=I(b.color.g,y.g,g),y.b=I(b.color.b,y.b,g),y.a=I(b.color.a,y.a,g),u.push({value:f,color:y,label:v.label})}else if("size"===e){var V=r[c],w=i[c-1],m=s.toPt(V.size),R=s.toPt(w.size),O=I(R,m,g);u.push({value:f,size:O,label:V.label})}else{var T=r[c],S=i[c-1],x=I(S.opacity,T.opacity,g);u.push({value:f,opacity:x,label:T.label})}}return[t].concat(u,[o])}function O(e){for(var i=e[0],t=e.slice(1),r=t.pop();t.length>N;){for(var o=0,n=0,l=1;l<t.length;l++){var a=t[l-1],s=t[l],u=Math.abs(s.value-a.value);u>n&&(n=u,o=l)}t.splice(o,1)}return[i].concat(t,[r])}function T(e,i){return i.length<=x?i:(S.warn("Found "+i.length+" Visual Variable stops, but MapView only supports "+x+". Displayed stops will be simplified."),i.length>2*x?R(e,i):O(i))}Object.defineProperty(i,"__esModule",{value:!0});var S=a.getLogger("esri.views.2d.layers.features.tileRenderer.SymbolTileRenderer"),x=8,N=x-2,C=function(e){function i(i){return e.call(this)||this}return t(i,e),i.prototype.createTile=function(e){var i=f.create();return this.tileInfoView.getTileBounds(i,e),new v(e,i)},i.prototype.disposeTile=function(e){this.featuresView.removeChild(e)},i.prototype.highlight=function(e){return this.featuresView.highlight(e)},i.prototype.hitTest=function(e,i){return this.featuresView.hitTest(e,i)},i.prototype.supportsRenderer=function(e){return null!=e&&d.isRendererWebGLCompatible(e)&&-1!==["simple","class-breaks","unique-value"].indexOf(e.type)},i.prototype.getProcessorConfiguration=function(){var e=this.layer,i=V(e.renderer);return{type:"symbol",renderer:i.toJSON(),devicePixelRatio:window.devicePixelRatio||1,definitionExpression:e.definitionExpression,outFields:e.outFields.slice().sort(),gdbVersion:e.gdbVersion,historicMoment:e.historicMoment&&e.historicMoment.getTime(),labelingInfo:e.labelingInfo&&e.labelingInfo.map(function(e){return e.toJSON()}),hasGeometryExpr:p.hasGeometryOperations(i)||e.labelingInfo&&e.labelingInfo.some(function(e){return p.hasGeometryOperations(e)})}},i.prototype.needsProcessorReconfiguration=function(e){var i=this.wouldClear(e),t=this.configuration;return this.configuration=e,i||t.definitionExpression!==e.definitionExpression},i.prototype.wouldClear=function(e){var i=this.configuration;if(!i||i.outFields.join()!==e.outFields.join()||c.diff(i.labelingInfo,e.labelingInfo))return!0;var t=this.configuration&&n.fromJSON(this.configuration.renderer)||null,r=e&&n.fromJSON(e.renderer)||null,o=c.diff(t,r);if(!o)return!1;switch(o.type){case"complete":return!0;case"partial":if(y(o))return!0;if(o.diff.visualVariables){var l=this.featuresView.visualVariablesInfo,a=this.tileInfoView.tileInfo.spatialReference,s={fields:this.layer.fields.map(function(e){return e.toJSON()})},u=d.getNormalizedRenderer(r,a,s),f=h.convertVisualVariables(u.visualVariables).vvFields;return!!c.diff(l.vvFields,f)}}},i.prototype.clear=function(){this.featuresView.disposeWebGLResources()},i.prototype.applyConfiguration=function(e){var i=n.fromJSON(e.renderer),t={fields:this.layer.fields.map(function(e){return e.toJSON()})},r=d.getNormalizedRenderer(i,this.tileInfoView.tileInfo.spatialReference,t);this.configuration=e,this.featuresView.visualVariablesInfo=h.convertVisualVariables(r.visualVariables)},i.prototype.install=function(e){var i=new g.default({highlightOptions:this.highlightOptions,tileInfoView:this.tileInfoView,layer:this.layer,layerView:this.layerView});this.featuresView=i,e.addChild(i)},i.prototype.uninstall=function(e){e.removeChild(this.featuresView),this.featuresView=null},i.prototype.onTileData=function(e){var i=this.tiles.get(e.tileKey);i&&this.featuresView.onTileData(i,e.data)},i.prototype.onTileError=function(e){var i=this.tiles.get(e.tileKey);i&&this.featuresView.onTileError(i)},i.prototype.getMaterialItems=function(e){return this.featuresView.getMaterialItems(e)},i=r([u.subclass()],i)}(u.declared(l,b.default));i.default=C});