// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.10/esri/copyright.txt for details.

define(["require","exports","../../../../../core/tsSupport/declareExtendsHelper","../../../../../core/tsSupport/decorateHelper","../../../../../core/tsSupport/assignHelper","@dojo/framework/shim/Set","../../../../../geometry","../../../../../core/Error","../../../../../core/has","../../../../../core/Logger","../../../../../core/promiseUtils","../../../../../core/QueueProcessor","../../../../../core/accessorSupport/decorators","../../../../../layers/graphics/featureConversionUtils","../../../../../layers/graphics/data/FeatureStore","../../../../../layers/graphics/data/QueryEngine","../../../../../layers/support/FeatureProcessing","../../../../../tasks/operations/query","../../../../../tasks/support/QuantizationParameters","../../../../../tasks/support/Query","../../../engine/webgl/Utils","./BaseController","../support/DataTile","../support/DataTileFeaturesIndex","../support/Tile","../support/TileUpdateQueue","../../../tiling/TileQueue"],function(e,t,r,i,s,n,o,a,u,l,d,c,p,h,f,y,g,_,m,v,x,T,Q,I,b,F,E){Object.defineProperty(t,"__esModule",{value:!0});var q=l.getLogger("esri.views.2d.layers.features.controllers.OnDemandController"),w=u("esri-featurelayer-webgl"),P=u("esri-mobile"),S={maxDrillLevel:w&&"object"==typeof w&&null!=w.maxDrillLevel?w.maxDrillLevel:P?1:4,maxRecordCountFactor:w&&"object"==typeof w&&null!=w.maxRecordCountFactor?w.maxRecordCountFactor:P?1:3,enablePBFQuery:!w||"object"!=typeof w||null==w.enablePBFQuery||w.enablePBFQuery},O=new n.default,j=[],C=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.type="on-demand",t._queryInfoHash=null,t._processingInMainThread=!1,t._dataTileIndex=new I.default,t._editsQueue=new c({concurrency:1,ordered:!0,process:function(e){return t._processEditsEvent(e)}}),t}return r(t,e),t.prototype.initialize=function(){var e=this;this._fetchQueue=new E({concurrency:10,strategy:"center-first",tileInfoView:this.tileStore.tileScheme,process:function(t){return e._fetchTile(t)}}),this._updateQueue=new F.default({tileInfoView:this.tileStore.tileScheme,process:function(t,r){return e._updateTile(t,r)}}),this.handles.add(this.watch("processor",this._switchProcessor.bind(this)))},t.prototype.destroy=function(){this._fetchQueue.clear(),this._updateQueue.clear(),this.queryEngine&&(this.queryEngine.destroy(),this._set("queryEngine",null))},Object.defineProperty(t.prototype,"processing",{get:function(){return g.fromWorker(this.configuration.processing)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"updating",{get:function(){return this._fetchQueue.updating||this._updateQueue.updating},enumerable:!0,configurable:!0}),t.prototype.onEdits=function(e){var t=this;this._fetchQueue.pause(),this._fetchQueue.reset(),this._editsQueue.push(e).then(function(){0===t._editsQueue.length&&t._fetchQueue.resume()})},t.prototype.queryFeatures=function(e){return this.queryEngine.executeQuery(v.fromJSON(e))},t.prototype.queryFeatureCount=function(e){return this.queryEngine.executeQueryForCount(v.fromJSON(e))},t.prototype.queryObjectIds=function(e){return this.queryEngine.executeQueryForIds(v.fromJSON(e))},t.prototype.queryExtent=function(e){return this.queryEngine.executeQueryForExtent(v.fromJSON(e))},t.prototype.redraw=function(){this._updateQueue.pause(),this._manageTiles(this.tileStore.tiles),this._updateQueue.resume()},t.prototype.refresh=function(){if(this.queryEngine&&this.queryEngine.destroy(),this.spatialIndex&&this.spatialIndex.clear(),this._dataTileIndex.spatialIndex=null,this._dataTileIndex.clear(),this._editsQueue.pause(),this._fetchQueue.pause(),this._updateQueue.pause(),this._editsQueue.clear(),this._fetchQueue.reset(),this._updateQueue.clear(),this.processor){var e=this.processor.queryInfo,t=e.definitionExpression,r=e.gdbVersion,i=e.historicMoment;this._set("spatialIndex",new f.default({geometryType:this.service.geometryType,hasM:!1,hasZ:!1})),this._set("queryEngine",new y.default({definitionExpression:t,fields:this.service.fields,geometryType:this.service.geometryType,objectIdField:this.service.objectIdField,hasM:!1,hasZ:!1,spatialReference:this.spatialReference.toJSON(),cacheSpatialQueries:!0,gdbVersion:r,historicMoment:null!=i&&new Date(i),spatialIndex:this.spatialIndex})),this._dataTileIndex.spatialIndex=this.spatialIndex,this._dataTileIndex.clear(),this._manageTiles(this.tileStore.tiles),this._fetchQueue.resume(),this._editsQueue.resume(),this._updateQueue.resume()}},t.prototype.setViewState=function(e){this._fetchQueue.state=e,this._updateQueue.state=e},t.prototype.onTileUpdate=function(e){this.queryEngine&&this._manageTiles(e.added,e.removed)},t.prototype._manageTiles=function(e,t){void 0===t&&(t=null);for(var r=this._dataTileIndex,i=this._fetchQueue,s=this._updateQueue,n="esriGeometryPoint"===this.service.geometryType,o=this,a=0,u=e;a<u.length;a++){var l=u[a];!function(e){var t=r.get(e.id);t?(t.displayTile=e,n?r.forEach(function(r){b.isChildOf(r,t)&&(r.displayTile=e)}):t.done=!1):(t=new Q.default,t.tile=e.clone(),t.displayTile=e,r.add(t)),o._processDataTile(t)}(l)}if(t)for(var d=0,c=t;d<c.length;d++){var l=c[d];O.add(l),s.cancel(l.id)}r.forEach(function(e){O.has(e.displayTile)&&j.push(e)});for(var p=0,h=j;p<h.length;p++){var f=h[p];i.has(f.id)&&i.getPromise(f.id).cancel(),r.delete(f)}j.length=0,O.clear()},t.prototype._processDataTile=function(e){var t=this,r=e.displayTile,i=e.key,s=this._dataTileIndex,n=this._fetchQueue,o=i.id,u=this._queryInfoHash,l=i.level-r.key.level>=S.maxDrillLevel;if(s.add(e),e.done||n.has(o)){if(e.queryInfoHash!==u||e.returnExceeded!==l)if(e.done)e.done=!1;else{if(!n.isOngoing(o))return e.queryInfoHash=u,void(e.returnExceeded=l);n.getPromise(o).cancel()}}else e.queryInfoHash=u,e.returnExceeded=l;if(e.done)return void this._invalidateTile(e.displayTile);n.has(o)||n.push(e).then(function(r){return t._handleResponse(e,r)}).catch(function(t){"cancel"!==t.dojoType&&q.error(new a("mapview-controller","Encountered an error when handling tile response",t)),e.done=!0})},t.prototype._handleResponse=function(e,t){if(e.done=!0,h.hydrateOptimizedFeatureSet(t),t.exceededTransferLimit)if(e.returnExceeded)this._dataTileIndex.setTileFeatures(e,t.features),this._deleteChildrenDataTiles(e);else for(var r=e.tile.createChildTiles(),i=0,s=r;i<s.length;i++){var n=s[i],o=new Q.default;o.tile=n,o.displayTile=e.displayTile,this._processDataTile(o)}else this._dataTileIndex.setTileFeatures(e,t.features),this._deleteChildrenDataTiles(e);this._invalidateTile(e.tile)},t.prototype._deleteChildrenDataTiles=function(e){this._dataTileIndex.forEach(function(t){b.isChildOf(t,e)&&j.push(t)});for(var t=0,r=j;t<r.length;t++){var i=r[t];this._fetchQueue.has(i.id)&&this._fetchQueue.getPromise(i.id).cancel(),this._dataTileIndex.delete(i)}j.length=0},t.prototype._fetchTile=function(e){var t=this,r=this._createQuery(e.displayTile,e.tile,e.returnExceeded),i=this.service.source;return S.enablePBFQuery&&this.service.capabilities.query.supportsFormatPBF?_.executeQueryPBF(i,r,{type:"optimized"}).then(function(e){return e.data}):_.executeQuery(i,r).then(function(e){return h.convertFromFeatureSet(e.data,t.service.objectIdField)})},t.prototype._invalidateTile=function(e){for(var t=this._updateQueue,r=this.tileStore.intersections(e,this.processor.queryInfo.pixelBuffer),i=0,s=r;i<s.length;i++){var n=s[i].tile;t.push(n.id,n.updateTimestamp)}},t.prototype._updateTile=function(e,t){var r=this,i=this.tileStore.get(e),s=this.processor.queryInfo,n=s.returnCentroid,o=s.returnGeometry,a=s.pixelBuffer,u=this.queryEngine.executeTileQuery(i,{pixelBuffer:a,returnGeometry:o,returnCentroid:n}),l=u.features,d=u.objectIds,c={features:l,fields:this.service.fields,objectIdFieldName:this.service.objectIdField,transform:{originPosition:"upperLeft",scale:[i.resolution,i.resolution],translate:[i.bounds[0],i.bounds[3]]}};return this._applyProcessing(c).catch(function(e){return e&&"cancel"!==e.dojoType&&q.error("updating-tile",e),c}).then(function(e){var s=[],n=!0;return r._dataTileIndex.forEach(function(e){i.id!==e.id&&b.isChildOf(e,i)&&n&&!e.done&&(n=!1)}),n&&i&&i.objectIds.forEach(function(e){d.has(e)||s.push(e)}),d.forEach(function(e){i.objectIds.add(e)}),i.updateTimestamp=t,r.processor.onTileData(i,{addOrUpdate:e.features,remove:s,transformParams:x.getTransformParams(e)}).catch(function(e){e&&"cancel"!==e.dojoType&&q.error("updating-tile",e)})})},t.prototype._processEditsEvent=function(e){var t=this;return d.create(function(r,i){var s=function(e){return e.objectId},n=e.deletedFeatures.map(s),o=t._dataTileIndex.deleteFeaturesById(n),a=e.addedFeatures.concat(e.updatedFeatures).map(s);if(a.length){var u=t.service.source,l=t._createObjectIdsQuery(a);_.executeQuery(u,l).then(function(e){var r=e.data;if(r&&r.features&&r.features.length){var i=h.convertFromFeatureSet(r,t.service.objectIdField).features;o.push.apply(o,t._dataTileIndex.addOrUpdateFeatures(i));for(var s=0,n=o;s<n.length;s++){var a=n[s];t._invalidateTile(a.tile)}}}).then(r,r)}else{for(var d=0,c=o;d<c.length;d++){var p=c[d];t._invalidateTile(p.tile)}r()}})},t.prototype._switchProcessor=function(e,t){var r=e.queryInfo,i=r.definitionExpression,s=r.gdbVersion,n=r.historicMoment,o=this._createQueryInfoHash(e);this._queryInfoHash!==o&&(this._queryInfoHash=o,this.queryEngine&&this.queryEngine.destroy(),this.spatialIndex&&this.spatialIndex.clear(),this._set("spatialIndex",new f.default({geometryType:this.service.geometryType,hasM:!1,hasZ:!1})),this._set("queryEngine",new y.default({definitionExpression:i,fields:this.service.fields,geometryType:this.service.geometryType,objectIdField:this.service.objectIdField,hasM:!1,hasZ:!1,spatialReference:this.spatialReference.toJSON(),cacheSpatialQueries:!0,gdbVersion:s,historicMoment:null!=n&&new Date(n),spatialIndex:this.spatialIndex})),this._dataTileIndex.spatialIndex=this.spatialIndex,this._dataTileIndex.forEach(function(e){e.done=!1})),this._editsQueue.pause(),this._fetchQueue.pause(),this._updateQueue.pause(),this._editsQueue.clear(),this._fetchQueue.reset(),this._updateQueue.clear(),this._manageTiles(this.tileStore.tiles),this._fetchQueue.resume(),this._editsQueue.resume(),this._updateQueue.resume()},t.prototype._createQuery=function(e,t,r){void 0===r&&(r=!0);var i=this.service.geometryType,s=this._createDefaultQuery(),n="esriGeometryPoint"===this.service.geometryType?t:e;return s.maxRecordCountFactor=S.maxRecordCountFactor,s.resultType="tile",s.returnExceededLimitFeatures=r,s.geometry=new o.Extent({xmin:t.bounds[0],ymin:t.bounds[1],xmax:t.bounds[2],ymax:t.bounds[3],spatialReference:this.spatialReference}),this.service.capabilities.query.supportsQuantization?(s.quantizationParameters=new m.default({mode:"view",originPosition:"upper-left",tolerance:n.resolution,extent:new o.Extent({xmin:n.bounds[0],ymin:n.bounds[1],xmax:n.bounds[2],ymax:n.bounds[3],spatialReference:this.spatialReference})}),"esriGeometryPolyline"===i&&(s.maxAllowableOffset=n.resolution)):"esriGeometryPolyline"!==i&&"esriGeometryPolygon"!==i||(s.maxAllowableOffset=n.resolution),s},t.prototype._createObjectIdsQuery=function(e){var t=this._createDefaultQuery();return t.objectIds=e,t},t.prototype._createDefaultQuery=function(){var e=this,t=this.processor.queryInfo,r=new v;r.outSpatialReference=this.spatialReference;var i=t.outFields,s=t.orderByFields;return this.processing&&(i=i&&i.filter(function(t){return!e.processing.getField(t)}),s=s&&s.filter(function(t){return!e.processing.getField(t)})),i=i.length/this.service.fields.length>=.75?["*"]:i,r.gdbVersion=t.gdbVersion,r.historicMoment=null!=t.historicMoment?new Date(t.historicMoment):null,r.outFields=i,r.where=t.definitionExpression||"1=1",r.returnGeometry=!0,r.returnCentroid=t.returnCentroid,r.orderByFields=s,r},t.prototype._applyProcessing=function(e){var t=this.processing;if(!t)return d.resolve(e);if(this._processingInMainThread)return this.remoteClient.invoke("executeProcessing",{featureSet:e});try{var r=t.process(e,t.options);return r?"then"in r?r:d.resolve(r):d.reject(new a("FeatureLayer","invalid processing.process() method, returns nothing"))}catch(t){return this._processingInMainThread=!0,this.remoteClient.invoke("executeProcessing",{featureSet:e})}},t.prototype._createQueryInfoHash=function(e){var t=this,r=e.queryInfo,i=r.orderByFields,s=r.outFields,n=e.queryInfo,o=n.definitionExpression,a=n.gdbVersion,u=n.historicMoment;return this.processing&&(s=s&&s.filter(function(e){return!t.processing.getField(e)}),i=i&&i.filter(function(e){return!t.processing.getField(e)})),s&&s.sort(),i&&i.sort(),JSON.stringify({definitionExpression:o,outFields:s.length/this.service.fields.length>=.75?["*"]:s,orderByFields:i,gdbVersion:a,historicMoment:u})},i([p.property()],t.prototype,"_fetchQueue",void 0),i([p.property()],t.prototype,"_updateQueue",void 0),i([p.property()],t.prototype,"configuration",void 0),i([p.property({readOnly:!0,dependsOn:["configuration"]})],t.prototype,"processing",null),i([p.property({readOnly:!0})],t.prototype,"queryEngine",void 0),i([p.property({readOnly:!0})],t.prototype,"spatialIndex",void 0),i([p.property({dependsOn:["_fetchQueue.updating","_updateQueue.updating"]})],t.prototype,"updating",null),t=i([p.subclass()],t)}(p.declared(T.default));t.default=C});